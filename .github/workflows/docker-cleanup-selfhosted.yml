name: Docker cleanup (self-hosted)

on:
  schedule:
    # run at 03:00 on the 1st of every month
    - cron: '0 3 1 * *'
  workflow_dispatch:
    inputs:
      days:
        description: 'Remove resources older than this many days'
        required: false
        default: '30'
      dry_run:
        description: 'If true, only show what would be deleted'
        required: false
        default: 'false'
      confirm:
        description: 'Must set to "yes" to allow manual non-dry run'
        required: false
        default: 'no'

permissions:
  contents: read

jobs:
  cleanup:
    name: Run Docker cleanup on self-hosted runner
    runs-on: [self-hosted, linux]
    concurrency:
      group: docker-cleanup-selfhosted
      cancel-in-progress: true
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Check runner Docker availability
        run: |
          if ! command -v docker >/dev/null 2>&1; then
            echo "docker CLI not found on runner. Aborting."; exit 1
          fi
          docker version --format '{{.Server.Version}}'

      - name: Safety check for manual non-dry run
        if: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.dry_run == 'false' || github.event.inputs.dry_run == '0' || github.event.inputs.dry_run == 'no') }}
        run: |
          if [ "${{ github.event.inputs.confirm || 'no' }}" != "yes" ]; then
            echo "Manual non-dry run requires confirm=yes input; aborting."; exit 1
          fi

      - name: Ensure cleanup script is present
        run: |
          if [ ! -f .devcontainer/cleanup/docker-prune-old.sh ]; then
            echo "Cleanup script not found at .devcontainer/cleanup/docker-prune-old.sh"; exit 1
          fi
          chmod +x .devcontainer/cleanup/docker-prune-old.sh

      - name: Run cleanup script
        env:
          DAYS: ${{ github.event.inputs.days || '30' }}
          DRY: ${{ github.event.inputs.dry_run || 'false' }}
        run: |
          echo "Running cleanup script (DAYS=${DAYS}, DRY=${DRY})"
          ./.devcontainer/cleanup/docker-prune-old.sh
