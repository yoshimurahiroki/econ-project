name: Paperpile to Notion

on:
  push:
    branches: [ master, main ]
    paths:
      - 'data/papers/**.bib'
      - 'data/papers/**.json'
      - 'data/papers/**.csljson'
      - 'tex/bibliography.bib'
      - 'tex/**/*.bib'
  workflow_dispatch:
    inputs:
      sync_offset:
        description: Start index for upsert window
        required: false
        default: '0'
      max_upserts:
        description: Max entries to upsert this run (0 = unlimited)
        required: false
        default: ''

jobs:
  sync:
    runs-on: ubuntu-latest
    concurrency:
      group: paperpile-to-notion
      cancel-in-progress: true
    steps:
      - name: Debounce 60s (wait for last push in a burst)
        run: sleep 60

      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install notion tools
        run: npm --prefix scripts ci || npm --prefix scripts install

      - name: Sync Bib to Notion (DB upsert)
        run: node scripts/notion-sync-db.js
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DB_ID: ${{ secrets.NOTION_DB_ID }}
          # Pick the primary bib to watch; can be overridden per-repo
          BIB_SOURCE: tex/bibliography.bib
          # Optional: enable Drive PDF matching for public/shared folder
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          DRIVE_FOLDER_ID: ${{ secrets.DRIVE_FOLDER_ID }}
          # Skip PDF processing in main job to reduce runtime
          SKIP_PDF: true
          # Bound work per run to avoid hitting 6h limits (set in repo variables)
          MAX_UPSERTS: ${{ github.event.inputs.max_upserts || vars.MAX_UPSERTS }}
          # Continue across runs (offset from previous state)
          SYNC_OFFSET: ${{ github.event.inputs.sync_offset || '0' }}

      - name: Upload touched entries
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: touched
          path: scripts/.out/updated.json

      - name: Upload sync state
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: sync-state
          path: scripts/.out/sync-state.json

  generate-ocr-matrix:
    needs: sync
    runs-on: ubuntu-latest
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: touched
          path: .
      - uses: actions/download-artifact@v4
        with:
          name: sync-state
          path: .
      - name: Build OCR matrix JSON
        id: build
        run: |
          set -euo pipefail
          if [ ! -f updated.json ]; then echo 'matrix={"include":[]}' >> "$GITHUB_OUTPUT"; exit 0; fi
          node -e '
            const fs=require("fs");
            let items=[]; try{ items=JSON.parse(fs.readFileSync("updated.json","utf8")); }catch{}
            const seen=new Set();
            const include=[];
            for (const it of items) {
              const k=(it.bibKey||"").trim(); if(!k || seen.has(k)) continue; seen.add(k);
              include.push({ bib_key: k });
              if (include.length>=parseInt(process.env.MAX_OCR||"10",10)) break;
            }
            const out={ include };
            process.stdout.write(`matrix=${JSON.stringify(out)}`);
          ' >> "$GITHUB_OUTPUT"
        env:
          MAX_OCR: ${{ vars.MAX_OCR }}
    outputs:
      matrix: ${{ steps.build.outputs.matrix }}

  # Self-dispatch if there is more work remaining (continue runs until done)
  continue-or-finish:
    needs: [sync, generate-ocr-matrix]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install script deps
        run: npm --prefix scripts ci || npm --prefix scripts install
      - uses: actions/download-artifact@v4
        with:
          name: sync-state
          path: .
      - name: Compute next offset
        id: next
        run: |
          set -euo pipefail
          if [ ! -f sync-state.json ]; then echo "next_offset=0" >> "$GITHUB_OUTPUT"; echo "remaining=0" >> "$GITHUB_OUTPUT"; exit 0; fi
          node -e '
            const fs=require("fs");
            const s=JSON.parse(fs.readFileSync("sync-state.json","utf8"));
            const next=Math.max(0, Number(s.nextOffset||0));
            const remaining=Math.max(0, Number(s.remaining||0));
            process.stdout.write(`next_offset=${next}\nremaining=${remaining}`);
          ' >> "$GITHUB_OUTPUT"
      - name: Dispatch next batch if remaining
        if: ${{ steps.next.outputs.remaining != '0' }}
        run: |
          echo "Dispatching follow-up run from offset ${{ steps.next.outputs.next_offset }}"
          node scripts/trigger-workflow.js
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITHUB_OWNER: ${{ github.repository_owner }}
          GITHUB_REPO: ${{ github.event.repository.name }}
          WORKFLOW_ID: paperpile-to-notion.yml
          REF: ${{ github.ref_name || 'master' }}

          # Encode inputs for workflow_dispatch using environment variables read by trigger script (see below change)
          WORKFLOW_INPUT_sync_offset: ${{ steps.next.outputs.next_offset }}
          WORKFLOW_INPUT_max_upserts: ${{ vars.MAX_UPSERTS }}

  ocr:
    needs: generate-ocr-matrix
    runs-on: ubuntu-latest
    if: ${{ fromJSON(needs.generate-ocr-matrix.outputs.matrix).include[0] != null }}
    strategy:
  fail-fast: false
      max-parallel: 2
      matrix: ${{ fromJSON(needs.generate-ocr-matrix.outputs.matrix) }}
    steps:
      - uses: actions/checkout@v4
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'
      - name: Install OCR deps and scripts deps
        run: |
          sudo apt-get update
          sudo apt-get install -y poppler-utils tesseract-ocr tesseract-ocr-eng
          npm --prefix scripts ci || npm --prefix scripts install
      - name: OCR and upload to Notion (per paper)
        run: node scripts/ocr-upload-notion.js
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DB_ID: ${{ secrets.NOTION_DB_ID }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          BIB_KEY: ${{ matrix.bib_key }}
          CHUNK_SIZE: 1500

  # Removed deprecated artifacts sync step
