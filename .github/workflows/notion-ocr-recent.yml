name: Notion OCR (recent pages)

on:
  workflow_dispatch:
    inputs:
      match_window:
        description: "Number of recent pages to scan for PDF URL"
        required: false
        default: "20"
      chunk_size:
        description: "OCR text chunk size"
        required: false
        default: "1500"

jobs:
  ocr-recent:
    runs-on: ubuntu-latest
    concurrency:
      group: notion-ocr-recent
      cancel-in-progress: true
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '20'

    - name: Install deps
        run: |
          sudo apt-get update
          sudo apt-get install -y poppler-utils tesseract-ocr tesseract-ocr-eng
      npm --prefix scripts ci || npm --prefix scripts install

      - name: OCR recent pages
        run: |
          node -e "(async()=>{const {Client}=await import('@notionhq/client'); const n=new Client({auth:process.env.NOTION_TOKEN}); const dbId=process.env.NOTION_DB_ID; const mw=parseInt(process.env.MATCH_WINDOW||'20',10); const cs=parseInt(process.env.CHUNK_SIZE||'1500',10); let cursor=undefined, got=[]; while(got.length<mw){ const r=await n.databases.query({database_id:dbId, sorts:[{timestamp:'last_edited_time',direction:'descending'}], page_size:Math.min(50,mw-got.length), start_cursor:cursor}); got.push(...r.results); if(!r.has_more) break; cursor=r.next_cursor;} const {default:cp}=await import('child_process'); for (const p of got){ const id=p.id; await new Promise((res,rej)=>{ const proc=cp.spawn('node',['scripts/ocr-upload-notion.js'],{stdio:'inherit',env:{...process.env,PAGE_ID:id,CHUNK_SIZE:String(cs)}}); proc.on('exit',c=> c===0?res():rej(new Error('child failed')));}); } })().catch(e=>{console.error(e);process.exit(1);})"
        env:
          NOTION_TOKEN: ${{ secrets.NOTION_TOKEN }}
          NOTION_DB_ID: ${{ secrets.NOTION_DB_ID }}
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          MATCH_WINDOW: ${{ inputs.match_window }}
          CHUNK_SIZE: ${{ inputs.chunk_size }}
